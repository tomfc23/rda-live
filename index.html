<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Player Scores</title>
  <style>
    body { font-family: Arial; background: #f9f9f9; padding: 20px; }
    .team { margin-bottom: 20px; }
    .team h2 { margin-bottom: 5px; }
    .player { margin-left: 10px; margin-bottom: 4px; }
    .total { font-weight: bold; margin-left: 10px; }
  </style>
</head>
<body>
  <h1>Player Scores worker fix</h1>
  <div id="results">Loading...</div>

  <script>
    const workerProxy = 'https://rda-worker.tomfconreal.workers.dev/?url=';

    const playersCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR7pZmpj4lJiBMkcjcgzJ77n2xmFIRlmuD-0Zuakz8lZekYobXkmTjfaEwhJYdNuM5F9VKlDm-FPaw8/pub?output=csv';
    const scheduleCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS93Cbk4JUmCBgtIR1-RnSHlYY9E-dxEEWVT_Jx-T_Lm07oa6KYlnBGAqaGJin4VBpG4GmOGn8ktTPy/pub?output=csv';

    async function fetchViaWorker(url) {
      const proxiedUrl = workerProxy + encodeURIComponent(url);
      const res = await fetch(proxiedUrl);
      if (!res.ok) throw new Error(`Fetch error: ${res.status}`);
      return res.text();
    }

    async function fetchJSONViaWorker(url) {
      const proxiedUrl = workerProxy + encodeURIComponent(url);
      const res = await fetch(proxiedUrl);
      if (!res.ok) throw new Error(`Fetch error: ${res.status}`);
      return res.json();
    }

    async function fetchCSV(url) {
      const text = await fetchViaWorker(url);
      return text.split('\n').map(line => line.split(',').map(x => x.trim()));
    }

    function getCurrentDateStringEST() {
      const nowUTC = new Date();
      const nowEST = new Date(nowUTC.getTime() - (5 * 60 * 60 * 1000));
      const currentHour = nowEST.getHours();
      const currentDate = new Date(nowEST);

      if (currentHour < 3) {
        currentDate.setDate(currentDate.getDate() - 1);
      }

      const month = currentDate.getMonth() + 1;
      const day = currentDate.getDate();
      return `${month}/${day}`;
    }

    function parseRankNumber(rawRank) {
      if (!rawRank) return Infinity;
      const match = rawRank.replace(/,/g, '').match(/(\d+)/);
      return match ? parseInt(match[1], 10) : Infinity;
    }

    function simplifyRank(rawRank) {
      if (!rawRank) return 'N/A';
      const clipped = rawRank.split(' of')[0];
      return clipped.trim();
    }

    function formatNumber(num) {
      return num.toLocaleString();
    }

    async function main() {
      const resultsDiv = document.getElementById('results');
      try {
        const [csv, scheduleCsv] = await Promise.all([
          fetchCSV(playersCsvUrl),
          fetchCSV(scheduleCsvUrl)
        ]);

        const todayDateString = getCurrentDateStringEST();
        const todaysTeams = new Set();
        scheduleCsv.slice(1).forEach(row => {
          const [gameId, date, team1, team2] = row;
          if (date === todayDateString) {
            if (team1) todaysTeams.add(team1);
            if (team2) todaysTeams.add(team2);
          }
        });

        const draftId = csv[0][1];
        const playersRaw = csv.slice(2)
          .filter(row => row[0] && row[1] && (row[3] || '').toLowerCase() === 'yes');

        const teams = {};
        resultsDiv.textContent = '';

        for (const row of playersRaw) {
          const [username, userId, teamName] = row;
          if (!todaysTeams.has(teamName)) continue;
          if (!teams[teamName]) teams[teamName] = [];

          const display = document.createElement('div');
          display.textContent = `${username} - loading...`;
          resultsDiv.appendChild(display);

          try {
            const url = `http://api.real.vg/games/playerratingcontest/${draftId}/view/${userId}?contestType=sport`;
            const data = await fetchJSONViaWorker(url);
            const rankInfo = data.info?.rankDisplayInfos?.[0] ?? {};
            const scoreRaw = rankInfo.scoreDisplay ?? '0';
            const rankRaw = rankInfo.rankDisplay ?? '';
            const score = parseFloat(scoreRaw) || 0;
            const rankNum = parseRankNumber(rankRaw);
            const rankDisplay = simplifyRank(rankRaw);

            teams[teamName].push({
              username,
              score,
              scoreDisplay: score.toFixed(2),
              rankDisplay,
              rankNum
            });

          } catch (e) {
            teams[teamName].push({
              username,
              score: 0,
              scoreDisplay: '0.00',
              rankDisplay: 'N/A',
              rankNum: Infinity
            });
          }
        }

        resultsDiv.innerHTML = '';

        if (Object.keys(teams).length === 0) {
          resultsDiv.textContent = 'No scheduled games today.';
          return;
        }

        for (const [teamName, players] of Object.entries(teams)) {
          players.sort((a, b) => a.rankNum - b.rankNum);
          const teamDiv = document.createElement('div');
          teamDiv.className = 'team';
          const header = document.createElement('h2');
          header.textContent = teamName;
          teamDiv.appendChild(header);

          let teamTotal = 0;
          players.forEach(player => {
            const playerDiv = document.createElement('div');
            playerDiv.className = 'player';
            playerDiv.textContent = `${player.username} - ${player.scoreDisplay} - ${player.rankDisplay}`;
            teamDiv.appendChild(playerDiv);
            teamTotal += player.score;
          });

          const totalDiv = document.createElement('div');
          totalDiv.className = 'total';
          totalDiv.textContent = `Team Total: ${teamTotal.toFixed(2)}`;
          teamDiv.appendChild(totalDiv);
          resultsDiv.appendChild(teamDiv);
        }

      } catch (e) {
        console.error('Main fetch failed:', e);
        resultsDiv.textContent = 'Failed to load CSV or API.';
      }
    }

    main();
  </script>
</body>
</html>
