<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RDA Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0A1B2A;
      color: #EAC76F;
      margin: 0;
      padding: 15px;
    }

    h1 {
      font-size: 24px;
      color: #FFD700;
      text-align: center;
      margin-bottom: 20px;
    }

    .matchup {
      background-color: #0F2236;
      border: 2px solid #FFD700;
      border-radius: 10px;
      margin-bottom: 20px;
      padding: 10px;
    }

    .matchup h2 {
      font-size: 16px;
      color: #FFD700;
      text-align: center;
      margin-bottom: 8px;
    }

    .team {
      background-color: #142A42;
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 10px;
    }

    .team h3 {
      font-size: 14px;
      color: #FFD700;
      margin-bottom: 5px;
    }

    .player {
      font-size: 14px;
      color: #FFFFFF;
      margin-left: 10px;
      margin-bottom: 4px;
    }

    #results {
      max-width: 600px;
      margin: 0 auto;
    }

    .win {
      color: #00FF00;
      font-weight: bold;
      margin-left: 5px;
    }

    .loss {
      color: #FF5555;
      font-weight: bold;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <h1>RDA Live</h1>
  <div id="loading">Loading...</div>
  <div id="results"></div>

  <script>
    const workerProxy = 'https://rda-worker.tomfconreal.workers.dev/?url=';

    const playersCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR7pZmpj4lJiBMkcjcgzJ77n2xmFIRlmuD-0Zuakz8lZekYobXkmTjfaEwhJYdNuM5F9VKlDm-FPaw8/pub?output=csv';
    const scheduleCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS93Cbk4JUmCBgtIR1-RnSHlYY9E-dxEEWVT_Jx-T_Lm07oa6KYlnBGAqaGJin4VBpG4GmOGn8ktTPy/pub?output=csv';

    async function fetchViaWorker(url) {
      const proxiedUrl = workerProxy + encodeURIComponent(url);
      const res = await fetch(proxiedUrl);
      if (!res.ok) throw new Error(`Fetch error: ${res.status}`);
      return res.text();
    }

    async function fetchJSONViaWorker(url) {
      const proxiedUrl = workerProxy + encodeURIComponent(url);
      const res = await fetch(proxiedUrl);
      if (!res.ok) throw new Error(`Fetch error: ${res.status}`);
      return res.json();
    }

    async function fetchCSV(url) {
      const text = await fetchViaWorker(url);
      return text.split('\n').map(line => line.split(',').map(x => x.trim()));
    }

    function getCurrentDateStringEST() {
      const nowUTC = new Date();
      const nowEST = new Date(nowUTC.getTime() - (5 * 60 * 60 * 1000));
      const currentHour = nowEST.getHours();
      const currentDate = new Date(nowEST);
      if (currentHour < 3) {
        currentDate.setDate(currentDate.getDate() - 1);
      }
      const month = currentDate.getMonth() + 1;
      const day = currentDate.getDate();
      return `${month}/${day}`;
    }

    function parseRankNumber(rawRank) {
      if (!rawRank) return Infinity;
      const match = rawRank.replace(/,/g, '').match(/(\d+)/);
      return match ? parseInt(match[1], 10) : Infinity;
    }

    function simplifyRank(rawRank) {
      if (!rawRank) return 'N/A';
      const clipped = rawRank.split(' of')[0];
      return clipped.trim();
    }

    async function main() {
      const resultsDiv = document.getElementById('results');
      const loadingDiv = document.getElementById('loading');
      try {
        const [csv, scheduleCsv] = await Promise.all([
          fetchCSV(playersCsvUrl),
          fetchCSV(scheduleCsvUrl)
        ]);

        const todayDateString = getCurrentDateStringEST();

        const matchups = [];
        scheduleCsv.slice(1).forEach(row => {
          const [gameId, date, team1, team2] = row;
          if (date === todayDateString) {
            matchups.push({ team1, team2 });
          }
        });

        const draftId = csv[0][1];
        const playersRaw = csv.slice(2)
          .filter(row => row[0] && row[1] && (row[3] || '').toLowerCase() === 'yes');

        const teams = {};
        let loadedPlayers = 0;
        const totalPlayers = playersRaw.length;

        resultsDiv.textContent = '';

        for (const row of playersRaw) {
          const [username, userId, teamName] = row;
          if (!teams[teamName]) teams[teamName] = [];

          try {
            const url = `http://api.real.vg/games/playerratingcontest/${draftId}/view/${userId}?contestType=sport`;
            const data = await fetchJSONViaWorker(url);
            const rankInfo = data.info?.rankDisplayInfos?.[0] ?? {};
            const scoreRaw = rankInfo.scoreDisplay ?? '0';
            const rankRaw = rankInfo.rankDisplay ?? '';
            const score = parseFloat(scoreRaw) || 0;
            const rankNum = parseRankNumber(rankRaw);
            const rankDisplay = simplifyRank(rankRaw);

            teams[teamName].push({
              username,
              score,
              scoreDisplay: score.toFixed(2),
              rankDisplay,
              rankNum
            });

          } catch (e) {
            teams[teamName].push({
              username,
              score: 0,
              scoreDisplay: '0.00',
              rankDisplay: 'N/A',
              rankNum: Infinity
            });
          }

          loadedPlayers++;
          loadingDiv.textContent = `Loaded ${loadedPlayers} out of ${totalPlayers} players...`;
        }

        loadingDiv.style.display = 'none';

        if (matchups.length === 0) {
          resultsDiv.textContent = 'No scheduled games today.';
          return;
        }

        for (const matchup of matchups) {
          const { team1, team2 } = matchup;

          const team1Players = teams[team1] || [];
          const team2Players = teams[team2] || [];

          const team1Total = team1Players.reduce((sum, p) => sum + p.score, 0).toFixed(2);
          const team2Total = team2Players.reduce((sum, p) => sum + p.score, 0).toFixed(2);

          const team1IsWinner = parseFloat(team1Total) > parseFloat(team2Total);
          const team2IsWinner = !team1IsWinner;

          const matchupDiv = document.createElement('div');
          matchupDiv.className = 'matchup';

          const matchupHeader = document.createElement('h2');
          matchupHeader.innerHTML = `${team1} (${team1Total}) <span class="${team1IsWinner ? 'win' : 'loss'}">${team1IsWinner ? 'W' : 'L'}</span> vs ${team2} (${team2Total}) <span class="${team2IsWinner ? 'win' : 'loss'}">${team2IsWinner ? 'W' : 'L'}</span>`;
          matchupDiv.appendChild(matchupHeader);

          function renderTeam(teamName, players) {
            const teamDiv = document.createElement('div');
            teamDiv.className = 'team';
            const teamHeader = document.createElement('h3');
            teamHeader.textContent = teamName;
            teamDiv.appendChild(teamHeader);

            players.sort((a, b) => a.rankNum - b.rankNum);
            players.forEach(player => {
              const playerDiv = document.createElement('div');
              playerDiv.className = 'player';
              playerDiv.textContent = `${player.username} - ${player.scoreDisplay} - ${player.rankDisplay}`;
              teamDiv.appendChild(playerDiv);
            });

            matchupDiv.appendChild(teamDiv);
          }

          renderTeam(team1, team1Players);
          renderTeam(team2, team2Players);

          resultsDiv.appendChild(matchupDiv);
        }

      } catch (e) {
        console.error('Fetch failed:', e);
        resultsDiv.textContent = 'Failed to load CSV or API.';
      }
    }

    main();
  </script>
</body>
</html>
