<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Player Scores 3</title>
  <style>
    body { font-family: Arial; background: #f9f9f9; padding: 20px; }
    .team { margin-bottom: 20px; }
    .team h2 { margin-bottom: 5px; }
    .player { margin-left: 10px; margin-bottom: 4px; }
    .total { font-weight: bold; margin-left: 10px; }
  </style>
</head>
<body>
  <h1>Player Scores by Team</h1>
  <div id="results">Loading...</div>

  <script>
    const corsProxy = 'https://corsproxy.io/?';
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR7pZmpj4lJiBMkcjcgzJ77n2xmFIRlmuD-0Zuakz8lZekYobXkmTjfaEwhJYdNuM5F9VKlDm-FPaw8/pub?output=csv';

    async function fetchCSV(url) {
      const res = await fetch(corsProxy + url);
      const text = await res.text();
      return text.split('\n').map(line => line.split(',').map(x => x.trim()));
    }

    async function fetchPlayerData(draftId, userId) {
      const url = `http://api.real.vg/games/playerratingcontest/${draftId}/view/${userId}?contestType=sport`;
      const res = await fetch(corsProxy + url);
      if (!res.ok) throw new Error(`API error: ${res.status}`);
      return res.json();
    }

    function parseRank(rawRank) {
      if (!rawRank) return Infinity;
      const match = rawRank.replace(/,/g, '').match(/(\d+)/);
      return match ? parseInt(match[1], 10) : Infinity;
    }

    function formatNumber(num) {
      return num.toLocaleString();
    }

    async function main() {
      const resultsDiv = document.getElementById('results');
      try {
        const csv = await fetchCSV(csvUrl);
        const draftId = csv[0][1];
        const playersRaw = csv.slice(2)
          .filter(row => row[0] && row[1] && (row[3] || '').toLowerCase() === 'yes');

        const teams = {};

        resultsDiv.textContent = '';

        for (const row of playersRaw) {
          const [username, userId, teamName] = row;

          if (!teams[teamName]) teams[teamName] = [];

          const display = document.createElement('div');
          display.textContent = `${username} - loading...`;
          resultsDiv.appendChild(display);

          try {
            const data = await fetchPlayerData(draftId, userId);
            const rankInfo = data.info?.rankDisplayInfos?.[0] ?? {};

            const scoreRaw = rankInfo.scoreDisplay ?? '0';
            const rankRaw = rankInfo.rankDisplay ?? '';

            const score = parseFloat(scoreRaw) || 0;
            const rankNum = parseRank(rankRaw);

            teams[teamName].push({
              username,
              score,
              scoreDisplay: score.toFixed(2),
              rankDisplay: formatNumber(rankNum),
              rankNum
            });

          } catch (e) {
            teams[teamName].push({
              username,
              score: 0,
              scoreDisplay: '0.00',
              rankDisplay: 'N/A',
              rankNum: Infinity
            });
          }
        }

        // Clear placeholder loading div
        resultsDiv.innerHTML = '';

        // Render teams
        for (const [teamName, players] of Object.entries(teams)) {
          players.sort((a, b) => a.rankNum - b.rankNum);

          const teamDiv = document.createElement('div');
          teamDiv.className = 'team';

          const header = document.createElement('h2');
          header.textContent = teamName;
          teamDiv.appendChild(header);

          let teamTotal = 0;

          players.forEach(player => {
            const playerDiv = document.createElement('div');
            playerDiv.className = 'player';
            playerDiv.textContent = `${player.username} - ${player.scoreDisplay} - ${player.rankDisplay}`;
            teamDiv.appendChild(playerDiv);
            teamTotal += player.score;
          });

          const totalDiv = document.createElement('div');
          totalDiv.className = 'total';
          totalDiv.textContent = `Team Total: ${teamTotal.toFixed(2)}`;
          teamDiv.appendChild(totalDiv);

          resultsDiv.appendChild(teamDiv);
        }

      } catch (e) {
        console.error('Main fetch failed:', e);
        resultsDiv.textContent = 'Failed to load CSV or API.';
      }
    }

    main();
  </script>
</body>
</html>
